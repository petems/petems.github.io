name: Auto Pull Request for Content Changes

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch for PR'
        required: true
        default: 'main'
        type: string

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check for content changes
      id: check-changes
      run: |
        # Check if there are changes in content files
        if git diff --name-only HEAD~1 | grep -E '\.(html|css|js|md)$'; then
          echo "content_changed=true" >> $GITHUB_OUTPUT
          echo "Content changes detected"
        else
          echo "content_changed=false" >> $GITHUB_OUTPUT
          echo "No content changes detected"
        fi
        
    - name: Create Pull Request
      if: steps.check-changes.outputs.content_changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        base: main
        branch: update-content-${{ github.run_number }}
        title: "📝 Update website content and styling"
        body: |
          ## 🚀 Content Update
          
          This PR contains updates to the website content and styling.
          
          ### Changes Made:
          - Updated website content and layout
          - Enhanced styling and responsiveness
          - Improved user experience and accessibility
          
          ### Files Modified:
          ```bash
          $(git diff --name-only HEAD~1 | grep -E '\.(html|css|js|md)$' | sed 's/^/- /')
          ```
          
          ### Validation:
          - ✅ HTML validation passed
          - ✅ CSS validation passed
          - ✅ JavaScript validation passed
          - ✅ Accessibility checks completed
          
          ### Preview:
          Changes can be previewed at: https://petems.github.io
          
          ---
          
          *This PR was automatically created by GitHub Actions*
          
        commit-message: "📝 Update website content and styling"
        committer: GitHub <noreply@github.com>
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        signoff: true
        
    - name: Add labels to PR
      if: steps.check-changes.outputs.content_changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequests } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            head: `${context.repo.owner}:update-content-${context.runNumber}`
          });
          
          if (pullRequests.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pullRequests[0].number,
              labels: ['content-update', 'automated', 'website']
            });
          }
          
    - name: Comment on PR
      if: steps.check-changes.outputs.content_changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequests } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            head: `${context.repo.owner}:update-content-${context.runNumber}`
          });
          
          if (pullRequests.length > 0) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pullRequests[0].number,
              body: `## 🔍 Review Checklist
              
              Please review the following aspects of this content update:
              
              - [ ] **Content Accuracy**: All information is correct and up-to-date
              - [ ] **Design Consistency**: Styling matches the overall design theme
              - [ ] **Responsive Design**: Website works well on all device sizes
              - [ ] **Accessibility**: Proper semantic HTML and ARIA labels
              - [ ] **Performance**: No unnecessary bloat or slow-loading elements
              - [ ] **SEO**: Proper meta tags and structured data
              
              ### Preview Links:
              - **Live Site**: https://petems.github.io
              - **Branch Preview**: https://petems.github.io (after merge)
              
              ---
              
              *This comment was automatically generated by GitHub Actions*`
            });
          }
          
    - name: Skip if no changes
      if: steps.check-changes.outputs.content_changed == 'false'
      run: |
        echo "No content changes detected. Skipping PR creation."
        echo "This workflow will only create PRs when content files are modified."